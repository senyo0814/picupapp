{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Landing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <link rel="apple-touch-icon" href="{% static 'img/logo192.png' %}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="PicUp">
    <meta name="theme-color" content="#2196f3">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light text-dark p-4">
    <div class="container bg-white p-4 rounded shadow">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
            <img id="appLogo" src="{% static 'img/logoside.png' %}" alt="PicUp App Logo" style="height: 40px;" />
            <div class="d-flex gap-3 border rounded px-3 py-2">
                <a href="{% url 'picupapp:about' %}?next=landing" class="text-primary">
                    <i class="fas fa-info-circle"></i>
                </a>
                <div id="darkModeToggleContainer" class="cursor-pointer">
                    <i id="darkModeIcon" class="fas fa-moon text-primary"></i>
                </div>
                {% if user.is_authenticated %}
                <a href="{% url 'picupapp:change_profile' %}" class="text-primary">
                    <i class="fas fa-user-cog"></i>
                </a>
                {% endif %}
            </div>
        </div>

        <h1 class="text-center fw-bold mb-4">Welcome, {{ username }}!</h1>

        <form method="POST" enctype="multipart/form-data" id="upload-form" class="border border-secondary rounded p-4 bg-light text-center" onsubmit="return handleUpload(event)">
            {% csrf_token %}
            <p class="text-muted mb-3">Drag and drop photos here or click to browse</p>
            <input id="file-input" type="file" name="images" accept="image/*" multiple class="d-none" />

            <p id="photoCount" class="text-muted small mt-2">0 of 5 photos selected</p>

            <div id="drop-zone" class="border border-secondary rounded bg-white p-5 cursor-pointer">
                <p class="text-muted">Drop files here or click to select</p>
            </div>

            <div id="preview" class="row row-cols-1 row-cols-sm-2 g-3 mt-4">
                <!-- preview items inserted via JS -->
            </div>

            <div id="comment-container" class="row row-cols-1 g-3 mt-4 text-start">
                <!-- comment inputs inserted via JS -->
            </div>

            <div id="metadata-wrapper" class="table-responsive mt-4" style="display: none;">
                <table id="metadata-table" class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Image</th>
                            <th>Date Taken</th>
                            <th>Camera</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Map</th>
                        </tr>
                    </thead>
                    <tbody id="metadata-body"></tbody>
                </table>
            </div>

            <div class="mb-3 text-start">
                <label class="form-label fw-semibold">Visibility</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="visibility" value="private" id="visPrivate">
                    <label class="form-check-label" for="visPrivate">Private</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="visibility" value="any" id="visAny" checked>
                    <label class="form-check-label" for="visAny">Any User</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="visibility" value="group" id="visGroup">
                    <label class="form-check-label" for="visGroup">Group</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="visibility" value="shared" id="visShared">
                    <label class="form-check-label" for="visShared">Shared</label>
                </div>
            </div>

            <div class="mb-3" id="groupDropdown" style="display: none;">
                <label for="photoGroup" class="form-label">Select Group</label>
                <select name="photo_group" id="photoGroup" class="form-select">
                    {% for group in user_groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
                <div class="mt-2 text-end">
                    <a href="{% url 'picupapp:create_group' %}" class="text-decoration-none text-primary small">+ Create New Group</a>
                </div>
            </div>

            <div class="mb-3" id="sharedUserSelect" style="display: none;">
                <label for="sharedWith" class="form-label">Share with specific users</label>
                <select name="shared_with" id="sharedWith" multiple class="form-select">
                    {% for user in all_users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted">Hold Ctrl (Cmd) to select multiple users.</small>
            </div>

            <button type="submit" class="btn btn-primary mt-3 spinner-link">Upload Photos</button>

            <p class="form-text text-muted mt-2">Note: A watermark with your name and the PicUp logo will be added before upload.</p>
        </form>

        <hr class="my-5">

        <div class="d-flex justify-content-center gap-2 mb-4">
            <a href="{% url 'picupapp:mappics' %}" class="btn btn-success spinner-link">View Photo Map</a>
            <a href="{% url 'picupapp:shared_photo_map' %}" class="btn btn-success spinner-link">
                <i class="fas fa-globe me-1"></i> View Public Photo Map
            </a>
        </div>

        <h2 class="fs-5 fw-semibold mb-4">Uploaded Photos</h2>
        <div class="row row-cols-2 row-cols-md-3 g-3">
            {% for photo in photos %}
            {% if photo.image %}
            <div class="col">
                <div class="card">
                    <button onclick="showExifModal('{{ photo.image.url }}','{{ photo.comment|escapejs }}','{{ photo.uploaded_at|date:"Y-m-d H:i:s" }}','{{ photo.photo_taken_date|default:"N/A"|date:"Y-m-d H:i:s" }}','{{ photo.latitude }}','{{ photo.longitude }}','{{ photo.id }}','{{ photo.shared_with.all|join:", " }}','{{ photo.uploaded_by.username }}','{{ photo.visibility }}','{{ photo.group.id|default_if_none:"" }}')" class="btn p-0 spinner-link">
                        <img src="{{ photo.image.url }}" class="card-img-top rounded" alt="Photo">
                    </button>
                    <div class="card-body">
                        <p class="text-muted small mb-1">By {{ photo.uploaded_by.username }}</p>
                        {% if photo.comment %}<p class="fst-italic small">"{{ photo.comment }}"</p>{% endif %}
                        {% if photo.uploaded_by == request.user %}
                        <form method="POST" action="{% url 'picupapp:delete_photo' photo.id %}" class="mt-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-link text-danger btn-sm spinner-link">Delete</button>
                        </form>
                        {% endif %}
                        <div class="small text-muted">
                            {% if photo.visibility == 'any' %}
                            <i class="fa-solid fa-users me-1"></i> Any User
                            {% elif photo.visibility == 'group' %}
                            <i class="fa-solid fa-user-group me-1"></i> Group
                            {% elif photo.visibility == 'shared' %}
                            <i class="fa-solid fa-user-plus me-1"></i> Shared<br />
                            <span class="ms-4">
                                {% for u in photo.shared_with.all %}{{ u.username }}{% if not forloop.last %}, {% endif %}{% empty %}(none){% endfor %}
                            </span>
                            {% else %}
                            <i class="fa-solid fa-lock me-1"></i> Private
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% empty %}
            <p>No photos yet.</p>
            {% endfor %}
        </div>
    </div>
    <!-- Modal update to allow visibility toggle -->
    <div class="modal fade" id="exifModal" tabindex="-1" aria-labelledby="exifModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exifModalLabel">Photo Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="modalImage" src="" alt="Full Photo" class="img-fluid rounded mb-3">
                    <form method="POST" action="/update-comment/" id="commentForm">
                        {% csrf_token %}
                        <input type="hidden" name="photo_id" id="modalPhotoId">
                        <div class="mb-3">
                            <label for="modalComment" class="form-label">Comment:</label>
                            <textarea name="comment" id="modalComment" class="form-control"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="modalVisibility" class="form-label">Visibility:</label>
                            <select name="visibility" id="modalVisibility" class="form-select">
                                <option value="private">Private</option>
                                <option value="any">Public (Any User)</option>
                                <option value="group">Group</option>
                                <option value="shared">Share with Users</option>
                            </select>
                        </div>
                        <div id="modalSharedWithContainer" class="mb-3 d-none">
                            <label for="modalSharedWith" class="form-label">Share with other users:</label>
                            <select name="shared_with_modal" id="modalSharedWith" multiple class="form-select">
                                <option value="__select_all__">(Select All Users)</option>
                                {% for user in all_users %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Hold Ctrl (or Cmd) to select multiple users.</small>
                        </div>
                        <div id="modalGroupContainer" class="mb-3 d-none">
                            <label for="modalGroup" class="form-label">Select Group:</label>
                            <select name="group_id" id="modalGroup" class="form-select">
                                <option value="">-- Choose Group --</option>
                                {% for group in user_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <a id="modalMapLink" href="#" target="_blank" class="btn btn-success d-none">View on Map</a>
                            <a id="modalFacebookShare" href="#" target="_blank" class="btn btn-info text-white">Share on Facebook</a>
                        </div>
                    </form>
                    <table class="table table-bordered table-sm mt-4">
                        <tbody>
                            <tr>
                                <th scope="row">Uploaded By:</th>
                                <td id="modalUploader"></td>
                            </tr>
                            <tr>
                                <th scope="row">Uploaded At:</th>
                                <td id="modalUploaded"></td>
                            </tr>
                            <tr>
                                <th scope="row">Date Taken:</th>
                                <td id="modalTaken"></td>
                            </tr>
                            <tr>
                                <th scope="row">Shared With:</th>
                                <td id="modalSharedWith"></td>
                            </tr>
                            <tr>
                                <th scope="row">Latitude:</th>
                                <td id="modalLat"></td>
                            </tr>
                            <tr>
                                <th scope="row">Longitude:</th>
                                <td id="modalLon"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Spinner -->
    <div id="loadingSpinner" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none justify-content-center align-items-center z-1050">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script>
        // Spinner handling
        window.addEventListener('load', () => {
            document.getElementById('loadingSpinner').classList.add('d-none');
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', () => {
                    document.getElementById('loadingSpinner').classList.remove('d-none');
                });
            });

            document.querySelectorAll('a.spinner-link').forEach(link => {
                link.addEventListener('click', () => {
                    document.getElementById('loadingSpinner').classList.remove('d-none');
                });
            });
        });

        // Modal handling
        function showExifModal(url, comment, uploaded, taken, lat, lon, photoId, sharedWith, uploader, visibility, groupId) {
            document.getElementById('modalImage').src = url;
            document.getElementById('modalComment').value = comment;
            document.getElementById('modalUploader').textContent = uploader || 'Unknown';
            document.getElementById('modalUploaded').textContent = uploaded;
            document.getElementById('modalTaken').textContent = taken;
            document.getElementById('modalLat').textContent = lat || "N/A";
            document.getElementById('modalLon').textContent = lon || "N/A";
            document.getElementById('modalPhotoId').value = photoId;

            const visSelect = document.getElementById('modalVisibility');
            const sharedBox = document.getElementById('modalSharedWithContainer');
            const groupBox = document.getElementById('modalGroupContainer');
            const sharedSelect = document.getElementById('modalSharedWith');
            const groupSelect = document.getElementById('modalGroup');

            visSelect.value = visibility || 'private';
            sharedBox.classList.add('d-none');
            groupBox.classList.add('d-none');
            sharedSelect.value = "";

            if (visibility === 'shared') {
                sharedBox.classList.remove('d-none');
                const sharedList = (sharedWith || "").split(",").map(name => name.trim());
                for (let opt of sharedSelect.options) {
                    opt.selected = sharedList.includes(opt.text);
                }
            } else if (visibility === 'group') {
                groupBox.classList.remove('d-none');
                if (groupSelect && groupId) {
                    groupSelect.value = groupId;
                }
            }

            const encodedUrl = encodeURIComponent(url);
            document.getElementById('modalFacebookShare').href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;

            const mapLink = document.getElementById('modalMapLink');
            if (lat && lon) {
                mapLink.href = `https://www.google.com/maps?q=${lat},${lon}`;
                mapLink.classList.remove('d-none');
            } else {
                mapLink.classList.add('d-none');
            }

            const modal = new bootstrap.Modal(document.getElementById('exifModal'));
            modal.show();
        }

        function closeExifModal() {
            const modalEl = document.getElementById('exifModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        }

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const preview = document.getElementById('preview');
        const commentContainer = document.getElementById('comment-container');
        const metadataWrapper = document.getElementById('metadata-wrapper');
        const metadataBody = document.getElementById('metadata-body');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('bg-primary-subtle');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-primary-subtle');
        });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('bg-primary-subtle');
            fileInput.files = e.dataTransfer.files;
            showPreview(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', () => {
            showPreview(fileInput.files);
        });

        let selectedFiles = [];

        function showPreview(files) {
            const maxPhotos = 5;
            const newFiles = Array.from(files);
            const combined = [...selectedFiles, ...newFiles];

            if (combined.length > maxPhotos) {
                alert(`You can upload a maximum of ${maxPhotos} photos.`);
                return;
            }

            selectedFiles = combined;
            preview.innerHTML = '';
            commentContainer.innerHTML = '';
            metadataBody.innerHTML = '';
            metadataWrapper.classList.add('d-none');

            selectedFiles.forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;

                const previewReader = new FileReader();
                previewReader.onload = e => {
                    const container = document.createElement('div');
                    container.className = 'position-relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'img-fluid rounded shadow mb-2';
                    container.appendChild(img);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.className = 'position-absolute top-0 end-0 btn btn-danger btn-sm rounded-start';
                    removeBtn.onclick = () => {
                        selectedFiles.splice(index, 1);
                        fileInput.files = createFileList(selectedFiles);
                        showPreview([]);
                    };
                    container.appendChild(removeBtn);

                    const commentInput = createCommentInput(file, index);
                    container.appendChild(commentInput);

                    preview.appendChild(container);
                };
                previewReader.readAsDataURL(file);

                const exifReader = new FileReader();
                exifReader.onload = async e => {
                    try {
                        const tags = await ExifReader.load(e.target.result);
                        const date = tags.DateTimeOriginal?.description || 'N/A';
                        const model = tags.Model?.description || 'N/A';
                        const latCoord = tags.GPSLatitude?.value ?? tags.GPSLatitude;
                        const latRef = tags.GPSLatitudeRef?.description ?? tags.GPSLatitudeRef;
                        const lonCoord = tags.GPSLongitude?.value ?? tags.GPSLongitude;
                        const lonRef = tags.GPSLongitudeRef?.description ?? tags.GPSLongitudeRef;

                        const lat = getGPSDecimal(latCoord, latRef);
                        const lon = getGPSDecimal(lonCoord, lonRef);

                        metadataBody.innerHTML += `
                            <tr>
                                <td class="border p-2">${file.name}</td>
                                <td class="border p-2">${date}</td>
                                <td class="border p-2">${model}</td>
                                <td class="border p-2">${lat ?? 'N/A'}</td>
                                <td class="border p-2">${lon ?? 'N/A'}</td>
                                <td class="border p-2">
                                    ${lat && lon ? `<a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" class="text-primary text-decoration-underline">View</a>` : 'N/A'}
                                </td>
                            </tr>
                        `;
                        metadataWrapper.classList.remove('d-none');

                        if (lat !== null && lon !== null) {
                            const hiddenInputs = document.createElement('div');
                            hiddenInputs.innerHTML = `
                                <input type="hidden" name="latitude_${index}" value="${lat}">
                                <input type="hidden" name="longitude_${index}" value="${lon}">
                                <input type="hidden" name="photo_taken_${index}" value="${date}">
                            `;
                            document.getElementById('upload-form').appendChild(hiddenInputs);
                        }

                    } catch (err) {
                        console.warn("EXIF read error:", err);
                    }
                };
                exifReader.readAsArrayBuffer(file);
            });

            document.getElementById('photoCount').textContent = `${selectedFiles.length} of ${maxPhotos} photos selected`;
        }

        function createFileList(files) {
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            return dt.files;
        }

        function createCommentInput(file, index) {
            const container = document.createElement('div');
            container.className = 'mt-2';

            const label = document.createElement('label');
            label.className = 'form-label';
            label.textContent = `Comment for ${file.name}`;

            const input = document.createElement('input');
            input.type = 'text';
            input.name = `comment_${index}`;
            input.className = 'form-control';

            container.appendChild(label);
            container.appendChild(input);

            return container;
        }

        function getGPSDecimal(coord, refTag) {
            if (!coord || coord.length !== 3) return null;

            const getValue = (entry) => {
                if (entry?.numerator !== undefined && entry?.denominator !== undefined) {
                    return entry.numerator / entry.denominator;
                } else if (Array.isArray(entry) && entry.length === 2) {
                    return parseFloat(entry[0]) / parseFloat(entry[1]);
                }
                return parseFloat(entry);
            };

            const d = getValue(coord[0]);
            const m = getValue(coord[1]);
            const s = getValue(coord[2]);

            if (isNaN(d) || isNaN(m) || isNaN(s)) return null;

            let result = d + m / 60.0 + s / 3600.0;

            const refRaw = (typeof refTag === 'string' ? refTag : refTag?.description || '').trim();
            const ref = refRaw.charAt(0).toUpperCase();
            if (ref === 'S' || ref === 'W') result *= -1;

            return result.toFixed(6);
        }

        document.querySelectorAll('input[name="visibility"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('groupDropdown').classList.toggle('d-none', radio.value !== 'group');
                document.getElementById('sharedUserSelect').classList.toggle('d-none', radio.value !== 'shared');
            });
        });

        document.getElementById('modalVisibility').addEventListener('change', function () {
            const sharedBox = document.getElementById('modalSharedWithContainer');
            const groupBox = document.getElementById('modalGroupContainer');
            sharedBox.classList.add('d-none');
            groupBox.classList.add('d-none');
            if (this.value === 'shared') {
                sharedBox.classList.remove('d-none');
            } else if (this.value === 'group') {
                groupBox.classList.remove('d-none');
            }
        });

        document.getElementById('modalSharedWith')?.addEventListener('change', function () {
            const isSelectAll = Array.from(this.selectedOptions).some(opt => opt.value === '__select_all__');
            if (isSelectAll) {
                Array.from(this.options).forEach(opt => {
                    opt.selected = opt.value !== '__select_all__';
                });
            }
        });

        // Dark Mode Logo
        function updateLogoForTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const logo = document.getElementById('appLogo');
            logo.src = isDark ? "{% static 'img/logosidedark.png' %}" : "{% static 'img/logoside.png' %}";
        }

        document.addEventListener('DOMContentLoaded', updateLogoForTheme);
        document.getElementById('darkModeToggleContainer')?.addEventListener('click', () => {
            setTimeout(updateLogoForTheme, 100);
        });
    </script>


</body>
</html>
