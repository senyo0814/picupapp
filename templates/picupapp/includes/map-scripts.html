<!-- Parse user + other photo JSON and merge -->
<script>
    const userPhotos = JSON.parse(document.getElementById('userPhotosJson').textContent);
    const otherPhotos = JSON.parse(document.getElementById('otherPhotosJson').textContent);
    const allPhotos = [...userPhotos, ...otherPhotos];
</script>

<script>
    let map;
    let markers = [];
    const globalUserColorMap = {};
    const allColors = ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#f1c40f', '#e67e22', '#1abc9c', '#34495e', '#d35400', '#7f8c8d', '#8e44ad', '#16a085'];
    let colorIndex = 0;
    let activeUsers = new Set();

    function highlightMatch(text, keyword) {
        if (!keyword) return text;
        return text.replace(new RegExp(`(${keyword})`, 'ig'), `<mark class="bg-yellow-300 dark:bg-yellow-500 text-black dark:text-white">$1</mark>`);
    }

    function updateCountryPhotoCount(photos, selectedCountry) {
        const count = photos.length;
        const nameEl = document.getElementById('selectedCountryName');
        const countEl = document.getElementById('photoCountForCountry');
        const suffixEl = document.getElementById('pluralSuffix');

        if (nameEl && countEl && suffixEl) {
            nameEl.textContent = selectedCountry || 'All Countries';
            countEl.textContent = count;
            suffixEl.textContent = count === 1 ? '' : 's';
        }
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 2,
            center: { lat: 37.7749, lng: -122.4194 }
        });

        populateCountryDropdown();
        renderMarkers();

        document.getElementById('legendSearch').addEventListener('input', () => {
            const keyword = document.getElementById('legendSearch').value.toLowerCase().trim();
            activeUsers.clear();
            if (keyword) {
                allPhotos.forEach(p => {
                    const user = p.user || 'Unknown';
                    if (user.toLowerCase().includes(keyword)) activeUsers.add(user);
                });
            }
            const allFilter = document.querySelector('input[name="legendFilter"][value="all"]');
            if (allFilter) allFilter.checked = activeUsers.size === 0;

            renderMarkers();
        });

        document.getElementById('countryFilter')?.addEventListener('change', renderMarkers);
    }

    window.initMap = initMap;

    function renderMarkers() {
        const legendList = document.getElementById('legendList');
        const selectedCountry = document.getElementById('countryFilter')?.value || "";
        const keyword = document.getElementById('legendSearch').value.toLowerCase().trim();

        // Clear map and legend
        markers.forEach(m => m.setMap(null));
        markers = [];
        legendList.querySelectorAll('button[data-user]').forEach(el => el.parentElement.remove());

        const bounds = new google.maps.LatLngBounds();
        const userMarkersMap = {};
        const filteredPhotos = [];

        allPhotos.forEach(photo => {
            const user = photo.user || 'Unknown';
            const matchUser = activeUsers.size === 0 || activeUsers.has(user);
            const matchCountry = !selectedCountry || photo.country === selectedCountry;

            if (!photo.latitude || !photo.longitude || !matchUser || !matchCountry) return;

            if (!userMarkersMap[user]) userMarkersMap[user] = [];
            userMarkersMap[user].push(photo);
            filteredPhotos.push(photo);
        });

        updateCountryPhotoCount(filteredPhotos, selectedCountry);

        Object.entries(userMarkersMap).forEach(([user, photos]) => {
            const color = globalUserColorMap[user] || (globalUserColorMap[user] = allColors[colorIndex++ % allColors.length]);
            const isActive = activeUsers.has(user);

            // Add legend entry
            const li = document.createElement('li');
            li.innerHTML = `
                <button data-user="${user}" class="legend-btn px-2 flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200 hover:text-blue-600 transition w-full text-left ${isActive ? 'bg-blue-100 text-blue-800 dark:bg-blue-600 dark:text-white font-semibold' : ''}">
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                    <span>${highlightMatch(user, keyword)}</span>
                </button>`;
            legendList.appendChild(li);

            // Create markers
            photos.forEach(photo => {
                const pos = { lat: photo.latitude, lng: photo.longitude };
                const marker = new google.maps.Marker({
                    position: pos,
                    map,
                    icon: {
                        url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                            <svg xmlns='http://www.w3.org/2000/svg' width='24' height='36' viewBox='0 0 24 36' fill='${color}'>
                                <path d='M12 0C7 0 3 4 3 9c0 6.5 9 18 9 18s9-11.5 9-18c0-5-4-9-9-9zM12 12.5c-2 0-3.5-1.5-3.5-3.5S10 5.5 12 5.5 15.5 7 15.5 9 14 12.5 12 12.5z'/>
                            </svg>`)}`
                    }
                });

                const popup = `
                    <div class="relative w-[300px] h-[300px] overflow-hidden rounded shadow">
                        <img src="${photo.image_url}" class="absolute inset-0 w-full h-full object-cover cursor-pointer" onclick="showFullscreenImage('${photo.image_url}')" />
                        <div class="absolute bottom-0 w-full text-white text-xs px-2 py-2 bg-black/40 backdrop-blur-sm">
                            <p class="font-semibold">
                                ${user}
                                ${photo.visibility === 'private' ? ' <i class="fas fa-lock ml-1 text-white/70" title="Private photo"></i>' : ''}
                            </p>
                            <p>${photo.comment || 'No comment'}</p>
                            <p class="text-[10px] text-white/70">${photo.taken}</p>
                        </div>
                    </div>`;

                const infowindow = new google.maps.InfoWindow({ content: popup });
                marker.addListener("click", () => infowindow.open(map, marker));
                markers.push(marker);
                bounds.extend(pos);
            });
        });

        if (markers.length > 0) {
            map.fitBounds(bounds);
        }

        // Legend filter click handlers
        legendList.querySelectorAll('button[data-user]').forEach(btn => {
            btn.addEventListener('click', () => {
                const user = btn.getAttribute('data-user');
                if (activeUsers.has(user)) {
                    activeUsers.delete(user);
                } else {
                    activeUsers.add(user);
                }

                const allFilter = document.querySelector('input[name="legendFilter"][value="all"]');
                const allUsers = new Set(allPhotos.map(p => p.user || 'Unknown'));
                if (allFilter) {
                    allFilter.checked = activeUsers.size === allUsers.size;
                }

                renderMarkers();
            });
        });
    }

    function populateCountryDropdown() {
        const select = document.getElementById('countryFilter');
        if (!select) return;

        const countries = [...new Set(allPhotos.map(p => p.country).filter(Boolean))].sort();
        select.innerHTML = `<option value="">All Countries</option>` + countries.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function showFullscreenImage(src) {
        const modal = document.getElementById('fullscreenImageModal');
        const img = document.getElementById('fullscreenImage');
        if (modal && img) {
            img.src = src;
            modal.classList.remove('hidden');
        }
    }

    function closeImageModal() {
        const modal = document.getElementById('fullscreenImageModal');
        const img = document.getElementById('fullscreenImage');
        if (modal && img) {
            modal.classList.add('hidden');
            img.src = '';
        }
    }
</script>

<script>
    const darkIcon = document.getElementById('darkModeIcon');
    const darkContainer = document.getElementById('darkModeToggleContainer');

    function applyThemeIcon(isDark) {
        darkIcon.classList.remove('fa-sun', 'fa-moon');
        darkIcon.classList.add(isDark ? 'fa-sun' : 'fa-moon');
        darkIcon.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    }

    const prefersDark = localStorage.getItem('theme') === 'dark' ||
        (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);

    if (prefersDark) {
        document.documentElement.classList.add('dark');
        applyThemeIcon(true);
    } else {
        document.documentElement.classList.remove('dark');
        applyThemeIcon(false);
    }

    darkContainer.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        applyThemeIcon(isDark);
    });
</script>
