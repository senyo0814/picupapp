{% extends 'picupapp/base.html' %}

{% block content %}
<!-- Row 1: Title and Controls -->
<div class="mb-2 flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-3 flex-wrap">
        <h5 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <i class="fas fa-map-marker-alt fa-2xl"></i> <span class="hidden sm:inline">Photo Map</span>
        </h5>
    </div>

    <div class="flex items-center gap-2 ml-auto">
        <a href="{% url 'picupapp:landing' %}"
           class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-2 rounded shadow transition">
            <i class="fa-solid fa-arrow-left"></i>
            <span class="hidden sm:inline">Back to Landing</span>
        </a>
        <div class="flex border rounded-md border-gray-400 items-center px-2 gap-2 cursor-pointer" style="padding: 0.13em 0.5em;" 
             id="darkModeToggleContainer">
            <span class="text-sm text-gray-700 dark:text-gray-200 hidden sm:inline">Theme</span>
            <i id="darkModeIcon"
               class="fas fa-moon text-xl text-blue-600 dark:text-yellow-400 transition"
               title="Toggle Dark Mode"></i>
        </div>
    </div>
</div>

<!-- Row 2: Horizontal Legend -->
<!-- Legend Row with Search -->
<!-- Legend Row -->
<div id="legend"
     class="mb-4 w-full px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow text-sm overflow-x-auto">

    <!-- Search Box -->
    <div class="mb-2 flex items-center gap-2">
        <input type="text" id="legendSearch" placeholder="Search user..."
               class="w-full sm:max-w-xs px-3 py-1 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 text-sm focus:outline-none focus:ring focus:ring-blue-400">
    </div>

    <!-- Horizontal Legend -->
    <ul id="legendList" class="flex flex-wrap items-center gap-4">
        <li>
            <label for="legend-select-all"
                   class="flex items-center gap-2 text-gray-700 dark:text-gray-200 cursor-pointer">
                <input type="radio" id="legend-select-all" name="legendFilter" value="all"
                       class="accent-blue-600" />
                <span>Select All</span>
            </label>
        </li>
    </ul>
</div>



<div class="relative h-[60vh] w-full rounded shadow border border-gray-300 dark:border-gray-600">
    <div id="map" class="h-full w-full rounded"></div>
</div>

<script>
    const userPhotos = {{ user_photos|safe }};
    const otherPhotos = {{ other_photos|safe }};
    const allPhotos = [...userPhotos, ...otherPhotos];

    let markers = [];
    let map;
    const globalUserColorMap = {};
    const allColors = [
        '#e74c3c', '#3498db', '#2ecc71', '#9b59b6',
        '#f1c40f', '#e67e22', '#1abc9c', '#34495e',
        '#d35400', '#7f8c8d', '#8e44ad', '#16a085'
    ];
    let colorIndex = 0;
    let activeUsers = new Set();

    function highlightMatch(text, keyword) {
        if (!keyword) return text;
        const regex = new RegExp(`(${keyword})`, 'ig');
        return text.replace(regex, '<mark class="bg-yellow-300 dark:bg-yellow-500 text-black dark:text-white">$1</mark>');
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 2,
            center: { lat: 37.7749, lng: -122.4194 }
        });

        renderMarkers();

        document.getElementById('legendSearch').addEventListener('input', () => {
            const keyword = document.getElementById('legendSearch').value.toLowerCase();

            // Update activeUsers to match search
            activeUsers = new Set();
            allPhotos.forEach(p => {
                const user = (p.user || 'Unknown');
                if (user.toLowerCase().includes(keyword)) {
                    activeUsers.add(user);
                }
            });

            // Uncheck Select All if search narrows result
            document.querySelector('input[name="legendFilter"][value="all"]').checked = false;

            renderMarkers();
        });
    }

    function renderMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];

        const bounds = new google.maps.LatLngBounds();
        const legendList = document.getElementById('legendList');
        legendList.querySelectorAll('button[data-user]').forEach(el => el.parentElement.remove());

        const userMarkersMap = {};

        allPhotos.forEach(photo => {
            if (!photo.latitude || !photo.longitude) return;

            const user = photo.user || 'Unknown';

            if (!globalUserColorMap[user]) {
                globalUserColorMap[user] = allColors[colorIndex % allColors.length];
                colorIndex++;
            }

            if (!userMarkersMap[user]) {
                userMarkersMap[user] = [];
            }
            userMarkersMap[user].push(photo);
        });

        Object.entries(userMarkersMap).forEach(([user, photos]) => {
            const keyword = document.getElementById('legendSearch').value.toLowerCase();
            if (keyword && !user.toLowerCase().includes(keyword)) return;

            const color = globalUserColorMap[user];
            const isActive = activeUsers.has(user);

            const li = document.createElement('li');
            li.innerHTML = `
                <button data-user="${user}"
                    class="legend-btn px-2 flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200 hover:text-blue-600 transition w-full text-left ${
                        isActive ? 'bg-blue-100 text-blue-800 dark:bg-blue-600 dark:text-white font-semibold' : ''
                    }">
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                    <span>${highlightMatch(user, keyword)}</span>
                </button>
            `;
            legendList.appendChild(li);

            photos.forEach(photo => {
                if (activeUsers.size > 0 && !activeUsers.has(user)) return;

                const pos = { lat: photo.latitude, lng: photo.longitude };
                const marker = new google.maps.Marker({
                    position: pos,
                    map,
                    icon: {
                        url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                            <svg xmlns='http://www.w3.org/2000/svg' width='24' height='36' viewBox='0 0 24 36' fill='${color}'>
                              <path d='M12 0C7 0 3 4 3 9c0 6.5 9 18 9 18s9-11.5 9-18c0-5-4-9-9-9zM12 12.5c-2 0-3.5-1.5-3.5-3.5S10 5.5 12 5.5 15.5 7 15.5 9 14 12.5 12 12.5z'/>
                            </svg>`)}`,
                    }
                });

                const popup = `
                    <div class="text-sm">
                        <img src="${photo.image_url}" class="max-w-full max-h-[300px] object-contain mx-auto mb-2" />
                        <p><strong>${user}</strong></p>
                        <p>${photo.comment || 'No comment'}</p>
                        <p class="text-gray-500 text-xs">${photo.taken}</p>
                    </div>
                `;
                const infowindow = new google.maps.InfoWindow({ content: popup });
                marker.addListener("click", () => {
                    infowindow.open(map, marker);
                    google.maps.event.addListenerOnce(infowindow, 'closeclick', () => {
                        if (markers.length > 0) {
                            const newBounds = new google.maps.LatLngBounds();
                            markers.forEach(m => newBounds.extend(m.getPosition()));
                            map.fitBounds(newBounds);
                        }
                    });
                });

                markers.push(marker);
                bounds.extend(pos);
            });
        });

        if (markers.length > 0) {
            map.fitBounds(bounds);
        }

        legendList.querySelectorAll('button[data-user]').forEach(btn => {
            btn.addEventListener('click', () => {
                const user = btn.getAttribute('data-user');
                if (activeUsers.has(user)) {
                    activeUsers.delete(user);
                } else {
                    activeUsers.add(user);
                }

                document.querySelector('input[name="legendFilter"][value="all"]').checked = false;

                const allUsers = new Set(allPhotos.map(p => p.user || 'Unknown'));
                document.querySelector('input[name="legendFilter"][value="all"]').checked =
                    allUsers.size === activeUsers.size &&
                    [...allUsers].every(u => activeUsers.has(u));

                renderMarkers();
            });
        });
    }
</script>

<script>
    const darkIcon = document.getElementById('darkModeIcon');
    const darkContainer = document.getElementById('darkModeToggleContainer');

    function applyThemeIcon(isDark) {
        darkIcon.classList.remove('fa-sun', 'fa-moon');
        darkIcon.classList.add(isDark ? 'fa-sun' : 'fa-moon');
        darkIcon.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    }

    const prefersDark = localStorage.getItem('theme') === 'dark' ||
        (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);

    if (prefersDark) {
        document.documentElement.classList.add('dark');
        applyThemeIcon(true);
    } else {
        document.documentElement.classList.remove('dark');
        applyThemeIcon(false);
    }

    darkContainer.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        applyThemeIcon(isDark);
    });
</script>


<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDD-kbmr3w3oN_M68drVB4ETtTmr3PGwn8&callback=initMap">
</script>
{% endblock %}
