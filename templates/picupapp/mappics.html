{% extends 'picupapp/base.html' %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
    <span>üìç</span> Photo Map
</h2>

<div class="mb-6">
    <a href="{% url 'picupapp:landing' %}"
       class="spinner-link inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow transition">
        ‚Üê Back to Landing
    </a>
</div>

<div class="mb-6 flex items-center gap-2">
    <input type="checkbox" id="toggleMine" class="accent-blue-600 h-4 w-4" checked />
    <label for="toggleMine" class="text-sm text-gray-700">
        Show Only My Photos (<strong class="text-black">{{ username }}</strong>)
    </label>
</div>

<div class="mb-6">
    <label for="userFilter" class="block text-sm font-semibold text-gray-700 mb-2">
        Filter by User:
    </label>
    <select id="userFilter"
            class="block w-full md:w-64 border border-gray-300 rounded-md px-3 py-2 text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500">
        <option value="all">All Users</option>
        {% for shared_user in shared_users %}
        <option value="{{ shared_user.username }}">{{ shared_user.username }}</option>
        {% endfor %}
    </select>
</div>

<div id="map" class="rounded shadow border border-gray-300 h-[60vh] w-full"></div>
<div id="legend" class="mt-4 p-4 border border-gray-300 rounded bg-white shadow text-sm max-w-md">
    <h3 class="font-semibold mb-2">Legend</h3>
    <ul id="legendList" class="space-y-1"></ul>
</div>


<!-- Scripts -->
<script>
    const userPhotos = {{ user_photos|safe }};
    const otherPhotos = {{ other_photos|safe }};
    const allPhotos = [...userPhotos, ...otherPhotos];

    let markers = [];
    let map;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 6,
            center: { lat: 37.7749, lng: -122.4194 }
        });

        renderMarkers(allPhotos);
        document.getElementById('userFilter').value = 'all';


        document.getElementById('toggleMine').addEventListener('change', function () {
            if (this.checked) {
                document.getElementById('userFilter').value = "{{ username }}";
                renderMarkers(userPhotos);
            } else {
                document.getElementById('userFilter').value = "all";
                renderMarkers(allPhotos);
            }
        });

        document.getElementById('userFilter').addEventListener('change', function () {
            const selectedUser = this.value;

            if (selectedUser === "{{ username }}") {
                document.getElementById('toggleMine').checked = true;
                renderMarkers(userPhotos);
            } else if (selectedUser === 'all') {
                document.getElementById('toggleMine').checked = false;
                renderMarkers(allPhotos);
            } else {
                document.getElementById('toggleMine').checked = false;
                const filtered = otherPhotos.filter(p => p.user === selectedUser);
                renderMarkers(filtered);
            }
        });

    }

    function renderMarkers(photos) {
        markers.forEach(m => m.setMap(null));
        markers = [];

        const bounds = new google.maps.LatLngBounds();

        const colors = [
            '#e74c3c', '#3498db', '#2ecc71', '#9b59b6',
            '#f1c40f', '#e67e22', '#1abc9c', '#34495e'
        ];

        const userColorMap = {};
        let colorIndex = 0;

        const legendList = document.getElementById('legendList');
        legendList.innerHTML = ''; // clear existing legend

        photos.forEach(photo => {
            const pos = { lat: photo.latitude, lng: photo.longitude };

            if (!userColorMap[photo.user]) {
                userColorMap[photo.user] = colors[colorIndex % colors.length];
                colorIndex++;
            }

            if (!legendList.querySelector(`[data-user="${photo.user}"]`)) {
                const li = document.createElement('li');
                li.setAttribute('data-user', photo.user);
                li.innerHTML = `
                    <span class="inline-block w-3 h-3 mr-2 rounded-full" style="background-color: ${userColorMap[photo.user]}"></span>
                    ${photo.user}
                `;
                legendList.appendChild(li);
            }

            const marker = new google.maps.Marker({
                position: pos,
                map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: userColorMap[photo.user],
                    fillOpacity: 1,
                    strokeColor: '#000',
                    strokeWeight: 1
                }
            });

            const popup = `
            <div class="text-sm">
                <img src="${photo.image_url}" class="max-w-full max-h-[300px] object-contain mx-auto mb-2" />
                <p><strong>${photo.user}</strong></p>
                <p>${photo.comment || 'No comment'}</p>
                <p class="text-gray-500 text-xs">${photo.taken}</p>
            </div>
        `;

            const infowindow = new google.maps.InfoWindow({ content: popup });
            marker.addListener("click", () => infowindow.open(map, marker));
            markers.push(marker);

            bounds.extend(pos);
        });

        if (photos.length > 0) {
            map.fitBounds(bounds);
        }
    }

</script>

<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDD-kbmr3w3oN_M68drVB4ETtTmr3PGwn8&callback=initMap">
</script>
{% endblock %}
